<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .hidden {
      display: none;
    }

    body {
      font-family: 'Poppins';
      background: linear-gradient(to bottom, #0f172a, #1e293b);
      color: #f1f5f9;
      overflow-x: hidden;
    }

    body {
      background: linear-gradient(to bottom, #AECBEB, #AECBEB);
      color: #13293d;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #ffffff;
      padding: 0 32px;
      color: #13293d;
      width: 100vw;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #logo {
      display: flex;
      align-items: center;
    }

    #logo h1 {
      margin-left: 8px;
      font-size: 20px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-actions h2 {
      font-size: 14px;
      margin-right: 4px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 30px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .logout-btn {
      background-color: #BEE9B8;
      color: #13293d;
      border: none;
      padding: 8px 12px;
      border-radius: 30px;
      font-size: 14px;
      cursor: pointer;
    }

    .about, .htp, .sdt {
      padding: 24px 32px;
    }

    .about h2, .htp h2, .sdt h2 {
      margin-bottom: 12px;
    }

    .htp ul, .sdt ul {
      background-color: rgba(0, 119, 182, 0.2);
      color: #13293d;
      padding: 16px 16px 16px 32px;
      border-radius: 12px;
      list-style-type: disc;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .htp ul li, .sdt ul li {
      margin-bottom: 8px;
      padding-left: 10px;
    }

    .hidden {
      display: none;
    }

    footer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background-color: #13293d;
      padding: 20px 32px;
      color: #ffffff;
      width: 100vw;
    }

    #footer-logo {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: flex-start;
    }

    .logo {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .logo h2 {
      margin-top: 15px;
      margin-left: 4px;
      font-size: 20px;
    }

    #footer-logo p {
      font-size: 14px;
      margin-top: 2px;
      margin-left: 18px;
    }

    .footer-developer {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      font-size: 14px;
      padding: 16px;
      gap: 700px
    }

    .developer-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 200px;
    }
    .developer-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 200px;
      flex-wrap: wrap;
    }

    .dashboard {
      display: flex;
      gap: 25px;
      padding: 68px;
      justify-content: center;
      flex-wrap: wrap;
      background: 
        linear-gradient(to bottom, #003450e1, #003450e1 ),
        url('bg.jpg');
      background-size: auto;
      background-position: center;
      background-repeat: no-repeat;
      color: white;
    }

    .user-card {
      background: rgba(255, 255, 255, 0);
      border-radius: 20px;
      padding: 24px;
      width: 40%;
      text-align: center;
    }

    .user-avatar {
      width: 300px;
      height: 300px;
      border-radius: 30%;
      margin-bottom: 16px;
      background-color: #cbd5e1;
      object-fit: cover;
    }

    .user-info {
      margin-top: 16px;
      align-content: center;
    }

    .user-info h3 {
      font-size: 24px;
      margin-bottom: 10px;
      padding: 15px 25px;
      background: linear-gradient(to bottom, #0076b67e, #aecceb81);
      border-radius: 10%;
      width: fit-content;
      margin: 0 auto;
    }

    .user-info button {
      margin-top: 10px;
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .user-info input {
      padding: 15px;
      margin-right: 8px;
      border-radius: 8px;
      border: none;
      font-size: 20px;
    }

    #leaderboardContainer {
      width: 50%;
    }

    .top-3 {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: -20px;
      margin-bottom: 24px;
    }

    .top-card {
      background-color: #1e293b;
      border-radius: 20px;
      padding: 5px;
      text-align: center;
      width: 26%;
      color: #f8fafc;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      word-break: break-word;
    }

    .top-card img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      margin-bottom: 16px;
    }


    .top-card.first {
      height: 200px;
      border-top: 4px solid gold;
    }

    .top-card.first img {
      width: 90px;
      height: 90px;
      margin-bottom: 50px;
    }

    .top-card.second {
      height: 160px;
      border-top: 4px solid silver;
    }

    .top-card.second img {
      margin-bottom: 20px;
    }

    .top-card.third {
      height: 140px;
      border-top: 4px solid #cd7f32;
    }

    .top-card.third img {
      margin-bottom: 18px;
    }

    .top-card .username {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .top-card .score {
      font-weight: bold;
      margin-bottom: 20px;
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0 auto;
      width: 80%;
      align-content: baseline;
    }

    .leaderboard-list li {
      background: rgb(255, 255, 255);
      padding: 12px 24px;
      margin-bottom: 10px;
      border-radius: 12px;
      display: flex;
      align-items: left;
      justify-content: space-between;
      color: black;
    }

    #leaderboard li {
      font-family: 'Poppins';
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background-color: rgb(255, 255, 255);
      border-radius: 12px;
      font-weight: bold;
    }

    #leaderboard li span.rank,
    #leaderboard li span.uname {
      text-align: right;
      margin-right: 18px;
      flex-shrink: 0;
    }

    #leaderboard li span.scores {
      margin-left: auto;
      text-align: left;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 18px;
      vertical-align: middle;
    }

    .leaderboard-list li.you {
      background-color: #4ade80 !important;
      color: #1e293b !important;
      font-weight: bold;
    }
  </style>
</head>
<header>
    <div id="logo">
      <img src="logo.png" alt="Logo" style="width: 50px; height: 50px;">
      <h1>Sudoku</h1>
    </div>

    <div class="header-actions">
      <h2>Deathmatch</h2>
      <a href="lobby.html">
        <button>Play</button>
      </a>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
</header>

<main class="dashboard">
  <section class="user-card">
    <img class="user-avatar" alt="User Avatar"/>
    <div class="user-info">

      <div id="UserPlace">
        <h3 id="displayUsername"></h3>
        <button onclick="toggleUserEdit()">
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>

      <div id="UserEdit" class="hidden">
        <input type="text" id="username" maxlength="29" placeholder="New Username" />
        <button id="change">
          <i class="fas fa-check"></i> Save
        </button>
      </div>
    </div>
  </section>



  <ol class="leaderboard"></ol>
  <div id="leaderboardContainer">
  <div class="top-3" id="top3"></div>
  <ul class="leaderboard-list" id="leaderboard"></ul>
  </div>
  <div id="status"></div>
</main>

  <div class="about">
    <h2>About Sudoku</h2>
    <p>The popular Japanese puzzle game Sudoku is based on the logical placement of numbers.
      An online game of logic, Sudoku doesn`t require any calculation nor special math skills; all that is needed are brains and concentration.</p>
  </div>

  <div class="htp">
    <h2>How to Play Sudoku</h2>
    <p>The goal of Sudoku is to fill in a 9x9 grid with digits so that each column, row, and 3x3 section contain the numbers between 1 to 9. At the beginning of the game, the 9x9 grid will have some of the squares filled in. Your job is to use logic to fill in the missing digits and complete the grid. Don`t forget, a move is incorrect if:</p>
    <ul>
      <li>Any row contains more than one of the same number from 1 to 9</li>
      <li>Any column contains more than one of the same number from 1 to 9</li>
      <li>Any 3x3 section contains more than one of the same number from 1 to 9</li>
    </ul>
  </div>

  <div class="sdt">
    <h2>Sudoku Tips</h2>
    <p>Sudoku is a fun puzzle game once you get the hang of it. At the same time, learning to play Sudoku can be a bit intimidating for beginners. So, if you are a complete beginner, here are a few Sudoku tips that you can use to improve your Sudoku skills.</p>
    <ul>
      <li>Tip 1: Look for rows, columns of 3x3 sections that contain 5 or more numbers. Work through the remaining empty cells, trying the numbers that have not been used. In many cases, you will find numbers that can only be placed in one position considering the other numbers that are already in its row, column, and 3x3 grid.</li>
      <li>Tip 2: Break the grid up visually into 3 columns and 3 rows. Each large column will have 3, 3x3 grids and each row will have 3, 3x3 grids. Now, look for columns or grids that have 2 of the same number. Logically, there must be a 3rd copy of the same number in the only remaining 9-cell section. Look at each of the remaining 9 positions and see if you can find the location of the missing number.</li>
    </ul>
  </div>
  
  <footer>
    <div id="footer-logo">
      <div class="logo">
        <img src="logo.png" alt="Logo" style="width: 50px; height: 50px;">
        <h2>Sudoku</h2>
      </div>
      <p>&copy; 2025 Sudoku Game. All rights reserved.</p>
    </div>

    <div class="footer-developer">
      <div class="developer-column">
        <p>Ara Rosalia Safitri</p>
        <p>23106050021@student.uin-suka.ac.id</p>
        <p> </p>
        <p>Chairul 'Azmi Zuhdi Pramono</p>
        <p>23106050024@student.uin-suka.ac.id</p>
      </div>
      <div class="developer-row">
        <p>Fahalliza Nastitie Dewi</p>
        <p>23106050030@student.uin-suka.ac.id</p>
        <p> </p>
        <p>Aimar Susanto</p>
        <p>12345@example.com</p>
      </div>
    </div>
  </footer>



  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAiVOX_F9rf0BmnNgqZM96hrBcocQ2dhRE",
      authDomain: "sudoku4-b6fe4.firebaseapp.com",
      databaseURL: "https://sudoku4-b6fe4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sudoku4-b6fe4",
      storageBucket: "sudoku4-b6fe4.appspot.com",
      messagingSenderId: "611453959407",
      appId: "1:611453959407:web:bfd851d26ac4b8a6ebef1a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const dbRef = ref(db);

    let currentUID = null;

    window.toggleUserEdit = function () {
      document.getElementById("UserPlace").classList.toggle("hidden");
      document.getElementById("UserEdit").classList.toggle("hidden");
    };

    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const email = user.email;
          const uid = user.uid;
          currentUID = uid;
          const avatarImg = document.querySelector(".user-avatar");
          if (avatarImg) {
            avatarImg.src = `https://i.pravatar.cc/80?u=${uid}`;
          }

          const userRef = ref(db, 'users/' + uid);

          get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              document.getElementById("displayUsername").innerText = data.username || "Blanc";
              document.getElementById("username").value = data.username || "";
            } else {
              window.location.href = "login.html";
            }
          });

          document.getElementById("change").addEventListener("click", () => {
            const newUsername = document.getElementById("username").value;
            const updatedData = {
              email: email,
              username: newUsername,
              score: 0
            };

            set(userRef, updatedData).then(() => {
              alert("Username diperbarui!");
              document.getElementById("displayUsername").innerText = newUsername;
              toggleUserEdit();
            });
          });
        } else {
          // window.location.href = "login.html";
        }
      });

          get(child(dbRef, 'users')).then((snapshot) => {
            if (snapshot.exists()) {
              const users = snapshot.val();
              const leaderboardArray = [];

              for (const uid in users) {
                const user = users[uid];
                leaderboardArray.push({
                  uid: uid,
                  username: user.username || "Blanc",
                  score: user.score || 0
                });
              }

              leaderboardArray.sort((a, b) => b.score - a.score);

              const top3 = leaderboardArray.slice(0, 3);
              const rest = leaderboardArray.slice(3);

              const top3Container = document.getElementById("top3");
              top3Container.innerHTML = "";

              const positions = ["second", "first", "third"];
              const rankNumbers = [2, 1, 3];

              [1, 0, 2].forEach((index, pos) => {
                const user = top3[index];
                const div = document.createElement("div");
                const avatarUrl = `https://i.pravatar.cc/80?u=${user.uid}`;
                div.className = `top-card ${positions[pos]}`;
                div.innerHTML = `
                  <img src="${avatarUrl}" alt="Avatar"/>
                  <div class="username">${user.username}</div>
                  <div class="score">${user.score}</div>
                `;
                top3Container.appendChild(div);
              });

              const leaderboardList = document.getElementById("leaderboard");
              leaderboardList.innerHTML = "";

              const middleRanks = rest.slice(0, 5);
              let currentUserRendered = false;

              middleRanks.forEach((user, index) => {
                const li = document.createElement("li");
                const isCurrentUser = user.uid === currentUID;
                const avatarUrl = `https://i.pravatar.cc/80?u=${user.uid}`;
                li.className = isCurrentUser ? "you" : "";
                li.innerHTML = `
                  <span class="rank">${index + 4}</span>
                  <img src="${avatarUrl}" alt="Avatar" class="avatar"/>
                  <span class="uname">${user.username}</span>
                  <span class="scores">${user.score}</span>
                `;
                leaderboardList.appendChild(li);

                if (isCurrentUser) {
                  currentUserRendered = true;
                }
              });

              // Cek apakah user ada di top3
              const inTop3 = top3.some(user => user.uid === currentUID);

              if (!inTop3 && !currentUserRendered) {
                const allUsers = [...top3, ...rest];
                const currentUserIndex = allUsers.findIndex(user => user.uid === currentUID);

                if (currentUserIndex !== -1) {
                  const currentUser = allUsers[currentUserIndex];
                  const avatarUrl = `https://i.pravatar.cc/80?u=${currentUser.uid}`;
                  const li = document.createElement("li");
                  li.className = "you";
                  li.innerHTML = `
                    <span class="rank">${currentUserIndex + 1}</span>
                    <img src="${avatarUrl}" alt="Avatar" class="avatar"/>
                    <span class="uname">${currentUser.username}</span>
                    <span class="scores">${currentUser.score}</span>
                  `;
                  leaderboardList.appendChild(li);
                }
              }
            }
          });
        });
    
    window.logout = () => {
        signOut(auth).then(() => {
            window.location.href = "login.html";
        }).catch((error) => {
            console.error("Logout gagal:", error);
        });
    };
  </script>
</body>
</html>
