<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deathmatch Sudoku</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    table { margin: 20px auto; border-collapse: collapse; }
    td {
      width: 40px; height: 40px;
      border: 1px solid #999;
      text-align: center;
    }
    input {
      width: 38px; height: 38px;
      font-size: 18px;
      text-align: center;
      border: none;
    }
    input[readonly] {
      background-color: #eee;
      font-weight: bold;
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .invalid { background-color: #fbb; }
    .box-border {
      border-right: 2px solid black;
      border-bottom: 2px solid black;
    }
    .num-pad {
            display: flex;
            flex-wrap: wrap;
            width: 150px;
            margin-top: 10px;
        }
        .num-pad button {
            width: 45px;
            height: 45px;
            font-size: 20px;
            margin: 2px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .num-pad button.active {
            transform: scale(0.9);
            background-color: lightgray;
        }
  </style>
</head>
<body>

<h1>Sudoku with Solver</h1>
<h2>Skor: <span id="score">0</span></h2>
<table id="sudoku-board"></table>

<div class="num-pad" id="numPad"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, get, push, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiVOX_F9rf0BmnNgqZM96hrBcocQ2dhRE",
    authDomain: "sudoku4-b6fe4.firebaseapp.com",
    databaseURL: "https://sudoku4-b6fe4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sudoku4-b6fe4",
    storageBucket: "sudoku4-b6fe4.appspot.com",
    messagingSenderId: "611453959407",
    appId: "1:611453959407:web:bfd851d26ac4b8a6ebef1a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const SIZE = 9;
  let score = 0;
  let solutionBoard = [];
  let confirm = null;
  let selectedInput = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    const uid = user.uid;
    const roomId = localStorage.getItem("currentRoomId");
    
    if (!roomId) return window.location.href = "dashboard.html";
    const isHostSnap = await get(ref(db, `lobby/${roomId}/players/${uid}/isHost`));
    if (isHostSnap.exists() && isHostSnap.val()) {
      const roomSnap = await get(ref(db, `lobby/${roomId}`));
      const room = roomSnap.val();
      if (!room.puzzle || !room.solution) {
        const fullBoard = generateFullBoard();
        const puzzle = generatePuzzle(fullBoard);
        solutionBoard = fullBoard;
        try{
          await update(ref(db, `lobby/${roomId}`), {
            puzzle,
            solution: solutionBoard,
            ready: true
          });
          alert("Sukses");
        } catch (error) {
          alert(error.message);
        }
      }
    }

    onValue(ref(db, `lobby/${roomId}`), (snap) => {
      const room = snap.val();
      if (room?.ready && room.puzzle && room.solution) {
        if (!doplet(confirm, room.puzzle)) {
          displayPuzzle(room.puzzle);
          confirm = room.puzzle.map(row => row.slice());
        }
        solutionBoard = room.solution;
      }
    });
  });

  function makepad() {
    let pad = document.getElementById("numPad");
    for (let i = 1; i <= 9; i++) {
      let tombol = document.createElement("button");
      tombol.textContent = i;
      tombol.id = `num-${i}`;
      tombol.onclick = () => {
        if (selectedInput) {
          selectedInput.value = i;
          checkInput({point: selectedInput});
        }
      };
      pad.appendChild(tombol);
    }
  }

  document.addEventListener("keydown", (event) => {
    if (selectedInput && event.key >= 1 && event.key <= 9) {
      selectedInput.value = event.key;
      checkInput({ point: selectedInput });
      let tombol = document.getElementById(`num-${event.key}`);
      if (tombol) {
        tombol.classList.add("active");
        setTimeout(() => tombol.classList.remove("active"), 100);
      }
    }
  });

  function doplet(p1, p2) {
    if (!p1 || !p2) return false;
    for (let i = 0; i < SIZE; i++) {
      for (let j = 0; j < SIZE; j++) {
        if (p1[i][j] !== p2[i][j]) return false;
      }
    }
    return true;
  }

  function isValid(board, row, col, num) {
    for (let i = 0; i < SIZE; i++) {
      if (i !== col && board[row][i] === num) return false;
      if (i !== row && board[i][col] === num) return false;

      const boxRow = 3 * Math.floor(row / 3) + Math.floor(i / 3);
      const boxCol = 3 * Math.floor(col / 3) + i % 3;
      if ((boxRow !== row || boxCol !== col) && board[boxRow][boxCol] === num) return false;
    }
    return true;
  }

  function createEmptyBoard() {
    return Array.from({ length: SIZE }, () => Array(SIZE).fill(0));
  }

  function fillBoard(board) {
    const nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
    for (let row = 0; row < SIZE; row++) {
      for (let col = 0; col < SIZE; col++) {
        if (board[row][col] === 0) {
          for (let num of nums) {
            if (isValid(board, row, col, num)) {
              board[row][col] = num;
              if (fillBoard(board)) return true;
              board[row][col] = 0;
            }
          }
          return false;
        }
      }
    }
    return true;
  }

  function generateFullBoard(fullBoard) {
    const board = createEmptyBoard();
    fillBoard(board);
    return board;
  }

  function hasUniqueSolution(board) {
    let count = 0;
    function solve(b) {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (b[r][c] === 0) {
            for (let n = 1; n <= 9; n++) {
              if (isValid(b, r, c, n)) {
                b[r][c] = n;
                solve(b);
                b[r][c] = 0;
              }
            }
            return;
          }
        }
      }
      count++;
    }
    solve(board.map(r => r.slice()));
    return count === 1;
  }

  function generatePuzzle(fullBoard) {
    solutionBoard = fullBoard.map(r => r.slice());
    const puzzle = fullBoard.map(row => row.slice());

    const positions = [];
    for (let r = 0; r < SIZE; r++) {
      for (let c = 0; c < SIZE; c++) {
        positions.push([r, c]);
      }
    }

    positions.sort(() => Math.random() - 0.5);

    for (const [r, c] of positions) {
      const backup = puzzle[r][c];
      puzzle[r][c] = 0;
      if (!hasUniqueSolution(puzzle)) {
        puzzle[r][c] = backup;
      }
    }

    return puzzle;
  }

  function displayPuzzle(puzzle) {
    const table = document.getElementById("sudoku-board");
    table.innerHTML = "";

    for (let row = 0; row < SIZE; row++) {
      const tr = document.createElement("tr");
      for (let col = 0; col < SIZE; col++) {
        const td = document.createElement("td");
        if ((col + 1) % 3 === 0 && col !== SIZE - 1) td.classList.add("box-border");
        if ((row + 1) % 3 === 0 && row !== SIZE - 1) td.classList.add("box-border");

        const input = document.createElement("input");
        input.setAttribute("type", "number");
        input.setAttribute("maxlength", "1");
        input.setAttribute("min", "1");
        input.setAttribute("max", "9");
        input.dataset.row = row;
        input.dataset.col = col;

        if (puzzle[row][col] !== 0) {
          input.value = puzzle[row][col];
          input.setAttribute("readonly", "true");
        } else {
          input.addEventListener("input", onInputChange);
        }

        td.appendChild(input);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
  }

  function getBoardFromInputs() {
    const board = createEmptyBoard();
    document.querySelectorAll("input").forEach(input => {
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      const val = parseInt(input.value);
      board[row][col] = isNaN(val) ? 0 : val;
    });

    return board;
  }

  function setBoardToInputs(solvedBoard) {
    document.querySelectorAll("input").forEach(input => {
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      if (!input.readOnly) {
        input.value = solvedBoard[row][col];
        input.classList.remove("invalid");
      }
    });
  }

  function onInputChange(e) {
    const input = e.target;
    const value = parseInt(input.value);
    const row = parseInt(input.dataset.row);
    const col = parseInt(input.dataset.col);
    input.classList.remove("invalid");
    if (isNaN(value) || value < 1 || value > 9) {
      input.classList.add("invalid");
      return;
    }

    const board = getBoardFromInputs();
    if (!isValid(board, row, col, value)) {
      input.classList.add("invalid");
      score--;
      updateScore();
      return;
    }
    if (solutionBoard[row][col] === value) {
      if (!input.dataset.correct) {
        input.dataset.correct = "true";
        score++;
        updateScore();
      }
    } else {
      if (input.dataset.correct) delete input.dataset.correct;
      score--;
      input.classList.add("invalid");
      updateScore();
    }
  }

  function solvedBoard(board) {
    for (let row = 0; row < SIZE; row++) {
      for (let col = 0; col < SIZE; col++) {
        if (board[row][col] === 0) {
          for (let num = 1; num <= 9; num++) {
            if (isValid(board, row, col, num)) {
              board[row][col] = num;
              if (solveBoard(board)) return true;
              board[row][col] = 0;
            }
          }
          return false;
        }
      }
    }
    return true;
  }

  function updateScore() {
    document.getElementById("score").textContent = score;
    const user = auth.currentUser;
    const roomId = localStorage.getItem("currentRoomId");
    if (user && roomId) {
      const scoreRef = ref(db, `lobby/${roomId}/players/${user.uid}/score`);
      set(scoreRef, score);
    }
  }
</script>

</body>
</html>